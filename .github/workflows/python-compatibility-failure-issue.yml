name: Python Compatibility Failure Issue Creation

on:
  workflow_run:
    workflows: ["Python Version Regression Detection"]
    types:
      - completed

jobs:
  create-issue-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
    - name: Get workflow run details
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Get the failed workflow run
          const runId = process.env.GITHUB_RUN_ID;

          // Create an issue for the failure
          const issueTitle = `[CI] Python Version Compatibility Test Failure - Run #${runId}`;

          const issueBody = `
          ## Python Version Compatibility Test Failure Detected

          A Python version compatibility test has failed in the CI pipeline.

          ## Workflow Run Details
          - Workflow: Python Version Regression Detection
          - Run ID: ${runId}
          - Conclusion: Failure
          - Repository: ${{ github.repository }}
          - Branch: ${{ github.ref }}

          ## Recommended Actions

          1. **Investigate the failure** by checking the workflow run logs
          2. **Identify the Python version** causing compatibility issues
          3. **Analyze the root cause** of the failure
          4. **Implement necessary fixes** to restore compatibility
          5. **Verify the fix** with comprehensive testing

          ## Links
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
          - [Job Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs)

          ## Common Causes

          - Syntax incompatibilities with newer Python versions
          - Deprecated standard library functions
          - Changes in asyncio behavior
          - Type hinting compatibility issues
          - Dependency compatibility problems

          @github-actions[bot] Please investigate this failure and create a detailed analysis.
          `;

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['ci-failure', 'python-version', 'bug']
          });

          console.log(`Created issue #${issue.data.number} for workflow failure`);
